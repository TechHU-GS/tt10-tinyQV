name: test
on: [push, workflow_dispatch]
jobs:
  rtl_test:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install iverilog
        shell: bash
        run: sudo apt-get update && sudo apt-get install -y iverilog

      - name: Run CRC16 unit test
        shell: bash
        run: |
          cd test
          iverilog -g2012 -DSIM -o tb_crc16.vvp \
            tb_crc16.v ../src/crc16_engine.v ../src/crc16_peripheral.v
          vvp tb_crc16.vvp > crc16_result.txt 2>&1 || true
          cat crc16_result.txt
          grep -q "ALL TESTS PASSED" crc16_result.txt

      - name: Run Watchdog unit test
        shell: bash
        run: |
          cd test
          iverilog -g2012 -DSIM -o tb_watchdog.vvp \
            tb_watchdog.v ../src/watchdog.v
          vvp tb_watchdog.vvp > wdt_result.txt 2>&1 || true
          cat wdt_result.txt
          grep -q "ALL TESTS PASSED" wdt_result.txt

      - name: Run I2C unit test
        shell: bash
        run: |
          cd test
          iverilog -g2012 -DSIM -o tb_i2c.vvp \
            tb_i2c.v ../src/i2c_master.v ../src/i2c_peripheral.v
          timeout 120 vvp tb_i2c.vvp > i2c_result.txt 2>&1 || true
          cat i2c_result.txt
          grep -q "ALL TESTS PASSED" i2c_result.txt

      - name: Run Seal unit test
        shell: bash
        run: |
          cd test
          iverilog -g2012 -DSIM -o tb_seal.vvp \
            tb_seal.v ../src/seal_register.v ../src/crc16_engine.v
          vvp tb_seal.vvp > seal_result.txt 2>&1 || true
          cat seal_result.txt
          grep -q "ALL TESTS PASSED" seal_result.txt

      - name: Run P0-A integration test
        shell: bash
        run: |
          cd test
          iverilog -g2012 -DSIM -o tb_integration.vvp \
            tb_integration.v qspi_flash_model.v \
            ../src/project.v ../src/latch_mem.v \
            ../src/crc16_engine.v ../src/crc16_peripheral.v \
            ../src/seal_register.v \
            ../src/i2c_master.v ../src/i2c_peripheral.v \
            ../src/watchdog.v ../src/rtc_counter.v \
            ../src/tinyQV/cpu/tinyqv.v ../src/tinyQV/cpu/alu.v \
            ../src/tinyQV/cpu/core.v ../src/tinyQV/cpu/counter.v \
            ../src/tinyQV/cpu/cpu.v ../src/tinyQV/cpu/decode.v \
            ../src/tinyQV/cpu/mem_ctrl.v ../src/tinyQV/cpu/qspi_ctrl.v \
            ../src/tinyQV/cpu/register.v ../src/tinyQV/cpu/latch_reg.v \
            ../src/tinyQV/peri/uart/uart_tx.v ../src/tinyQV/peri/uart/uart_rx.v \
            ../src/tinyQV/peri/spi/spi.v
          timeout 300 vvp tb_integration.vvp > integration_result.txt 2>&1 || true
          cat integration_result.txt
          grep -q "ALL TESTS PASSED" integration_result.txt

      - name: Run P0-B integration test
        shell: bash
        run: |
          cd test
          iverilog -g2012 -DSIM -o tb_integration_b.vvp \
            tb_integration_b.v qspi_flash_model.v qspi_psram_model.v i2c_slave_model.v \
            ../src/project.v ../src/latch_mem.v \
            ../src/crc16_engine.v ../src/crc16_peripheral.v \
            ../src/seal_register.v \
            ../src/i2c_master.v ../src/i2c_peripheral.v \
            ../src/watchdog.v ../src/rtc_counter.v \
            ../src/tinyQV/cpu/tinyqv.v ../src/tinyQV/cpu/alu.v \
            ../src/tinyQV/cpu/core.v ../src/tinyQV/cpu/counter.v \
            ../src/tinyQV/cpu/cpu.v ../src/tinyQV/cpu/decode.v \
            ../src/tinyQV/cpu/mem_ctrl.v ../src/tinyQV/cpu/qspi_ctrl.v \
            ../src/tinyQV/cpu/register.v ../src/tinyQV/cpu/latch_reg.v \
            ../src/tinyQV/peri/uart/uart_tx.v ../src/tinyQV/peri/uart/uart_rx.v \
            ../src/tinyQV/peri/spi/spi.v
          timeout 600 vvp tb_integration_b.vvp > integration_b_result.txt 2>&1 || true
          cat integration_b_result.txt
          grep -q "ALL TESTS PASSED" integration_b_result.txt

      - name: Run read-clear regression test
        shell: bash
        run: |
          cd test
          iverilog -g2012 -DSIM -o tb_read_clear_regression.vvp \
            tb_read_clear_regression.v \
            ../src/project.v ../src/latch_mem.v \
            ../src/crc16_engine.v ../src/crc16_peripheral.v \
            ../src/seal_register.v \
            ../src/i2c_master.v ../src/i2c_peripheral.v \
            ../src/watchdog.v ../src/rtc_counter.v \
            ../src/tinyQV/cpu/tinyqv.v ../src/tinyQV/cpu/alu.v \
            ../src/tinyQV/cpu/core.v ../src/tinyQV/cpu/counter.v \
            ../src/tinyQV/cpu/cpu.v ../src/tinyQV/cpu/decode.v \
            ../src/tinyQV/cpu/mem_ctrl.v ../src/tinyQV/cpu/qspi_ctrl.v \
            ../src/tinyQV/cpu/register.v ../src/tinyQV/cpu/latch_reg.v \
            ../src/tinyQV/peri/uart/uart_tx.v ../src/tinyQV/peri/uart/uart_rx.v \
            ../src/tinyQV/peri/spi/spi.v
          timeout 120 vvp tb_read_clear_regression.vvp > regression_result.txt 2>&1 || true
          cat regression_result.txt
          grep -q "ALL TESTS PASSED" regression_result.txt

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            test/*_result.txt
